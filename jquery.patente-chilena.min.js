/* Copyright (c) 2015 Vincent Guyard (vguyard@onaxis.cl) http://www.onaxis.cl
 * Licensed under GPL (http://www.opensource.org/licenses/gpl-2.0.php)
 * Use only for non-commercial usage.
 *
 * Version : 0.1
 *
 */
!function(r){jQuery.fn.PatenteChilena=function(i){var e={digito_verificador:null,on_error:function(){},on_success:function(){},validation:!0,format:!0,format_on:"change"};r.extend(e,i);return this.each(function(){if(e.format&&jQuery(this).bind(e.format_on,function(){jQuery(this).val(jQuery.PatenteChilena.formatear(jQuery(this).val(),null==e.digito_verificador))}),e.validation)if(null==e.digito_verificador)jQuery(this).bind("blur",function(){var r=jQuery(this).val();""==jQuery(this).val()||jQuery.PatenteChilena.validar(r)?""!=jQuery(this).val()&&e.on_success():e.on_error()});else{var r=jQuery(this).attr("id");jQuery(e.digito_verificador).bind("blur",function(){var i=jQuery("#"+r).val()+"-"+jQuery(this).val();""==jQuery(this).val()||jQuery.PatenteChilena.validar(i)?""!=jQuery(this).val()&&e.on_success():e.on_error()})}})}}(jQuery),jQuery.PatenteChilena={formatear:function(r,i){var e=new String(r);e=jQuery.PatenteChilena.quitarFormato(e);var t=e.length>6?e.substring(6):!1;return e=e.substring(0,6),6==e.length&&(e=jQuery.PatenteChilena.esAntigua(e)?[e.slice(0,2),"-",e.slice(2)].join(""):[e.slice(0,4),"-",e.slice(4)].join("")),t&&(e+="-"+t),e},quitarFormato:function(r){return r.replace(/\W+/g,"").toUpperCase()},esAntigua:function(r){return r.match(/^[a-z]{2}[\.\- ]?[0-9]{2}[\.\- ]?[0-9]{2}$/i)},esNueva:function(r){return r.match(/^[b-d,f-h,j-l,p,r-t,v-z]{2}[\-\. ]?[b-d,f-h,j-l,p,r-t,v-z]{2}[\.\- ]?[0-9]{2}$/i)},validar:function(r){if(r=jQuery.PatenteChilena.quitarFormato(r),7!=r.length)return!1;var e=r.substring(6);if(r=r.substring(0,6),!this.esAntigua(r)&&!this.esNueva(r))return!1;var t=0,a=2,n=0,u=0;for(i=r.length-1;i>=0;i--){var o=r.charAt(i);if(("P"==o||"0"==o)&&(t=0),"B"==o||"Q"==o||"1"==o)var t=1;if("C"==o||"R"==o||"2"==o)var t=2;if("D"==o||"S"==o||"3"==o)var t=3;if("F"==o||"T"==o||"4"==o)var t=4;if("G"==o||"V"==o||"5"==o)var t=5;if("H"==o||"W"==o||"6"==o)var t=6;if("J"==o||"X"==o||"7"==o)var t=7;if("K"==o||"Y"==o||"8"==o)var t=8;if("L"==o||"Z"==o||"9"==o)var t=9;var n=n+t*a,a=a+1}var v=n%11,u=11-v;if(10==u)var u="K";if(11==u)var u="0";return u==e}};